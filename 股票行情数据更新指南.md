# 股票行情数据更新指南

## 概述

您现在拥有一个完整的 **5657 只股票** 的基础数据库。为了让您的应用显示最新的行情数据，您需要定期执行数据更新。

本指南将教您如何使用"一键更新"工具 `update_now.py` 来快速更新所有股票的行情数据。

---

## 为什么要自己更新？

1. **效率高**：在 Render 本地运行，无远程传输延迟，5000+ 只股票的数据补全只需 10-20 分钟
2. **不消耗积分**：完全在您的 Render 服务器上执行，不占用 Manus 的资源
3. **灵活性强**：您可以随时更新，无需等待我的响应
4. **成本低**：没有额外的 API 调用成本

---

## 快速开始

### 第一步：获取 update_now.py 脚本

将 `update_now.py` 脚本上传到您的 Render 项目中。您可以：

**选项 A：通过 Git 提交**
```bash
# 在您的本地项目目录中
git clone https://github.com/henrylin99/quantitativeanalysis.git
cd quantitativeanalysis

# 将 update_now.py 放入项目根目录
# 然后提交
git add update_now.py
git commit -m "Add one-click update script"
git push
```

**选项 B：直接上传到 Render**
1. 登录 Render 控制台
2. 进入您的 Quantitative Analysis 项目
3. 点击 "Shell" 标签进入命令行
4. 使用 `nano` 或 `vi` 编辑器创建文件，或通过 SFTP 上传

### 第二步：在 Render 上执行更新

1. **登录 Render 控制台**：https://dashboard.render.com/
2. **进入您的项目**：找到 "quantitative-analysis-lzsj" 项目
3. **打开 Shell**：点击项目名称，然后点击 "Shell" 标签
4. **运行更新脚本**：
   ```bash
   python update_now.py
   ```

### 第三步：等待更新完成

脚本会输出进度信息：
```
============================================================
股票行情数据一键更新工具
============================================================

[1/4] 连接到 Baostock...
[OK] Baostock 登录成功

[2/4] 获取股票列表...
[OK] 获取到 5657 只股票

[3/4] 更新行情数据...
[PROGRESS] 已处理 100/5657 只股票，已插入 2500 条记录
[PROGRESS] 已处理 200/5657 只股票，已插入 5000 条记录
...
[OK] 数据更新完成，共插入 125000 条记录

[4/4] 清理资源...
[OK] 完成

============================================================
更新成功！请刷新您的 Render 页面查看最新数据。
============================================================
```

---

## 更新频率建议

| 场景 | 推荐频率 | 说明 |
|------|--------|------|
| **首次初始化** | 1 次 | 补全过去 1 年的历史数据，需要 15-20 分钟 |
| **日常维护** | 每个交易日 1 次 | 在收盘后（16:00）运行，只更新当天新增数据，需要 5-10 分钟 |
| **周末检查** | 可选 | 检查是否有遗漏的数据 |

---

## 常见问题

### Q1：更新需要多长时间？

**A：** 取决于需要更新的数据量：
- **首次运行**（补全 1 年历史）：15-20 分钟
- **日常更新**（仅更新当天）：5-10 分钟

### Q2：更新过程中可以中断吗？

**A：** 可以。脚本设计了断点续传机制：
- 每只股票的数据是独立插入的
- 如果中途中断，下次运行时会自动从上次中断的地方继续
- 已插入的数据不会重复

### Q3：更新会覆盖已有的数据吗？

**A：** 不会。脚本使用 `ON DUPLICATE KEY UPDATE` 语法：
- 如果该日期的数据已存在，会更新为最新值
- 如果是新数据，会直接插入
- 不会删除任何已有数据

### Q4：如何验证更新是否成功？

**A：** 更新完成后：
1. 刷新您的 Render 应用页面
2. 查看股票列表中是否显示了最新的价格和涨跌幅
3. 点击某只股票查看其详细数据和技术指标

### Q5：如何自动化每日更新？

**A：** 您有两个选项：

**选项 1：使用 Render 的 Cron Job（推荐）**
- 在 Render 控制台配置一个定时任务
- 每个交易日 16:00 自动运行 `python update_now.py`
- 完全自动，无需手动干预

**选项 2：使用您的本地计算机**
- 在您的电脑上设置 Windows 任务计划或 Linux Cron
- 定期调用 Render 的 API 或 Shell 执行更新

---

## 脚本工作原理

```
┌─────────────────────────────────────────────────────────┐
│  update_now.py 工作流程                                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. 连接 Baostock 数据源                                │
│     ↓                                                    │
│  2. 从数据库获取所有股票列表（5657 只）                 │
│     ↓                                                    │
│  3. 对每只股票：                                        │
│     ├─ 查询数据库中的最后更新日期                      │
│     ├─ 从 Baostock 获取该日期之后的所有行情            │
│     ├─ 计算技术指标（如需要）                          │
│     └─ 插入或更新数据库                                │
│     ↓                                                    │
│  4. 返回更新统计信息                                    │
│     ↓                                                    │
│  5. 断开连接，完成                                      │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 数据更新范围

### 包含的数据

- **股票代码**：所有 A 股上市公司（沪深京三市）
- **行情数据**：开盘价、收盘价、最高价、最低价、成交量、涨跌幅等
- **时间范围**：从 2024 年 1 月 1 日至今（首次运行）
- **更新频率**：支持日线数据更新

### 不包含的数据（暂不支持）

- 分钟线数据
- 财务数据（如财报、分红等）
- 资金流向数据
- 期权、期货等衍生品

---

## 故障排除

### 问题 1：脚本运行失败，提示"数据库连接错误"

**解决方案：**
1. 检查 Render 环境变量是否正确配置
2. 确认 `sqlpub.com` 数据库是否在线
3. 尝试在 Render Shell 中测试连接：
   ```bash
   python -c "import pymysql; conn = pymysql.connect(host='mysql2.sqlpub.com', port=3307, user='liquidity', password='ZvdbAoGQGX0Pki1b', database='quantitativeanalysis'); print('连接成功'); conn.close()"
   ```

### 问题 2：脚本运行缓慢或超时

**解决方案：**
1. 这是正常的。首次运行需要 15-20 分钟
2. 如果超过 30 分钟仍未完成，可以中断并重新运行
3. 脚本会自动从上次中断的地方继续

### 问题 3：某些股票的数据为空

**解决方案：**
1. 这可能是 Baostock 数据源的问题
2. 脚本会自动跳过无法获取的股票
3. 下次运行时会重新尝试

---

## 下一步建议

1. **立即运行**：在 Render Shell 中执行 `python update_now.py`
2. **验证数据**：刷新应用页面，确认数据已更新
3. **设置自动化**：配置 Render Cron Job 实现每日自动更新
4. **监控日志**：定期检查更新是否成功

---

## 技术支持

如果遇到任何问题，请提供以下信息：
- 错误消息的完整内容
- 脚本执行时的输出日志
- 您的 Render 项目名称

---

**祝您使用愉快！** 🚀
